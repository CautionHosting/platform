#!/bin/bash
# SPDX-FileCopyrightText: 2025 Caution SEZC
# SPDX-License-Identifier: AGPL-3.0-only OR LicenseRef-Commercial

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/../.env" ]]; then
    source "$SCRIPT_DIR/../.env"
fi

DB_HOST="${DB_HOST:-localhost}"
DB_PORT="${DB_PORT:-5432}"
DB_NAME="${DB_NAME:-caution}"
DB_USER="${DB_USER:-postgres}"
DB_PASSWORD="${DB_PASSWORD:-postgres}"

export PGPASSWORD="$DB_PASSWORD"

UUID_REGEX='^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'

validate_uuid() {
    local id="$1"
    if ! [[ "$id" =~ $UUID_REGEX ]]; then
        echo "Error: Invalid UUID format: $id"
        exit 1
    fi
}

psql_cmd() {
    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -t -A "$@"
}

psql_pretty() {
    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" "$@"
}

cmd_help() {
    cat <<EOF
Caution Admin CLI

Usage: ./scripts/admin <command> [args]

Commands:
  list-orgs              List all organizations
  show-org <id>          Show organization details with members and apps
  freeze-org <id>        Freeze an organization
  unfreeze-org <id>      Unfreeze an organization
  list-users             List all users
  show-user <id>         Show user details
  list-apps              List all deployments/apps
  show-app <id>          Show app details

Examples:
  ./scripts/admin list-orgs
  ./scripts/admin show-org 123e4567-e89b-12d3-a456-426614174000
  ./scripts/admin freeze-org 123e4567-e89b-12d3-a456-426614174000
EOF
}

cmd_list_orgs() {
    echo "=== Organizations ==="
    psql_pretty -c "
        SELECT
            o.id,
            o.name,
            COALESCE(o.is_frozen, false) as frozen,
            (SELECT COUNT(*) FROM organization_members WHERE organization_id = o.id) as members,
            (SELECT COUNT(*) FROM deployments WHERE organization_id = o.id) as apps,
            o.created_at::date as created
        FROM organizations o
        ORDER BY o.created_at DESC;
    "
}

cmd_show_org() {
    local org_id="$1"
    validate_uuid "$org_id"

    echo "=== Organization ==="
    psql_pretty -c "
        SELECT id, name, COALESCE(is_frozen, false) as frozen, created_at, updated_at
        FROM organizations WHERE id = '$org_id';
    "

    echo ""
    echo "=== Members ==="
    psql_pretty -c "
        SELECT u.id, u.username, u.email, om.role, om.created_at as joined
        FROM organization_members om
        JOIN users u ON u.id = om.user_id
        WHERE om.organization_id = '$org_id'
        ORDER BY om.role, u.username;
    "

    echo ""
    echo "=== Apps/Deployments ==="
    psql_pretty -c "
        SELECT id, name, state, created_at, updated_at
        FROM deployments
        WHERE organization_id = '$org_id'
        ORDER BY created_at DESC;
    "
}

cmd_freeze_org() {
    local org_id="$1"
    validate_uuid "$org_id"

    local org_name
    org_name=$(psql_cmd -c "SELECT name FROM organizations WHERE id = '$org_id'")
    if [[ -z "$org_name" ]]; then
        echo "Error: Organization not found: $org_id"
        exit 1
    fi

    local is_frozen
    is_frozen=$(psql_cmd -c "SELECT COALESCE(is_frozen, false) FROM organizations WHERE id = '$org_id'")
    if [[ "$is_frozen" == "t" ]]; then
        echo "Organization '$org_name' is already frozen"
        exit 0
    fi

    psql_cmd -c "UPDATE organizations SET is_frozen = true, updated_at = NOW() WHERE id = '$org_id'"
    echo "Organization '$org_name' has been frozen"
}

cmd_unfreeze_org() {
    local org_id="$1"
    validate_uuid "$org_id"

    local org_name
    org_name=$(psql_cmd -c "SELECT name FROM organizations WHERE id = '$org_id'")
    if [[ -z "$org_name" ]]; then
        echo "Error: Organization not found: $org_id"
        exit 1
    fi

    local is_frozen
    is_frozen=$(psql_cmd -c "SELECT COALESCE(is_frozen, false) FROM organizations WHERE id = '$org_id'")
    if [[ "$is_frozen" == "f" ]]; then
        echo "Organization '$org_name' is not frozen"
        exit 0
    fi

    psql_cmd -c "UPDATE organizations SET is_frozen = false, updated_at = NOW() WHERE id = '$org_id'"
    echo "Organization '$org_name' has been unfrozen"
}

cmd_list_users() {
    echo "=== Users ==="
    psql_pretty -c "
        SELECT
            u.id,
            u.username,
            u.email,
            (SELECT COUNT(*) FROM organization_members WHERE user_id = u.id) as orgs,
            u.created_at::date as created
        FROM users u
        ORDER BY u.created_at DESC;
    "
}

cmd_show_user() {
    local user_id="$1"
    validate_uuid "$user_id"

    echo "=== User ==="
    psql_pretty -c "
        SELECT id, username, email, created_at, updated_at
        FROM users WHERE id = '$user_id';
    "

    echo ""
    echo "=== Organizations ==="
    psql_pretty -c "
        SELECT o.id, o.name, om.role, om.created_at as joined
        FROM organization_members om
        JOIN organizations o ON o.id = om.organization_id
        WHERE om.user_id = '$user_id'
        ORDER BY om.created_at;
    "
}

cmd_list_apps() {
    echo "=== Apps/Deployments ==="
    psql_pretty -c "
        SELECT
            d.id,
            d.name,
            d.state,
            o.name as org,
            d.created_at::date as created
        FROM deployments d
        JOIN organizations o ON o.id = d.organization_id
        ORDER BY d.created_at DESC
        LIMIT 50;
    "
}

cmd_show_app() {
    local app_id="$1"
    validate_uuid "$app_id"

    echo "=== App/Deployment ==="
    psql_pretty -c "
        SELECT
            d.id,
            d.name,
            d.state,
            d.domain,
            d.git_url,
            d.git_ref,
            o.name as organization,
            d.created_at,
            d.updated_at
        FROM deployments d
        JOIN organizations o ON o.id = d.organization_id
        WHERE d.id = '$app_id';
    "
}

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        help|--help|-h)
            cmd_help
            ;;
        list-orgs)
            cmd_list_orgs
            ;;
        show-org)
            [[ $# -lt 1 ]] && { echo "Error: Missing org ID"; exit 1; }
            cmd_show_org "$1"
            ;;
        freeze-org)
            [[ $# -lt 1 ]] && { echo "Error: Missing org ID"; exit 1; }
            cmd_freeze_org "$1"
            ;;
        unfreeze-org)
            [[ $# -lt 1 ]] && { echo "Error: Missing org ID"; exit 1; }
            cmd_unfreeze_org "$1"
            ;;
        list-users)
            cmd_list_users
            ;;
        show-user)
            [[ $# -lt 1 ]] && { echo "Error: Missing user ID"; exit 1; }
            cmd_show_user "$1"
            ;;
        list-apps)
            cmd_list_apps
            ;;
        show-app)
            [[ $# -lt 1 ]] && { echo "Error: Missing app ID"; exit 1; }
            cmd_show_app "$1"
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run './scripts/admin help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
