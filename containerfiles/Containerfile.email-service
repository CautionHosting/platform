FROM stagex/pallet-rust@sha256:9c38bf1066dd9ad1b6a6b584974dd798c2bf798985bf82e58024fbe0515592ca AS pallet-rust
FROM stagex/core-gcc@sha256:964ffd3793c5a38ca581e9faefd19918c259f1611c4cbf5dc8be612e3a8b72f5 AS gcc
FROM stagex/core-musl@sha256:d9af23284cca2e1002cd53159ada469dfe6d6791814e72d6163c7de18d4ae701 AS musl
FROM stagex/core-libunwind@sha256:eb66122d8fc543f5e2f335bb1616f8c3a471604383e2c0a9df4a8e278505d3bc AS libunwind
FROM stagex/core-ca-certificates@sha256:d135f1189e9b232eb7316626bf7858534c5540b2fc53dced80a4c9a95f26493e AS ca-certificates
FROM stagex/core-user-runtime@sha256:055ae534e1e01259449fb4e0226f035a7474674c7371a136298e8bdac65d90bb AS user-runtime

FROM pallet-rust AS builder

ENV SOURCE_DATE_EPOCH=1
ENV CARGO_HOME=/usr/local/cargo

WORKDIR /build

COPY Cargo.toml Cargo.lock ./
COPY src/api/Cargo.toml ./src/api/
COPY src/gateway/Cargo.toml ./src/gateway/
COPY src/email-service/Cargo.toml ./src/email-service/
COPY src/enclave-builder/Cargo.toml ./src/enclave-builder/

RUN mkdir -p src/api/src src/gateway/src src/enclave-builder/src && \
    echo "fn main() {}" > src/api/src/main.rs && \
    echo "fn main() {}" > src/gateway/src/main.rs && \
    echo "pub fn dummy() {}" > src/enclave-builder/src/lib.rs

COPY src/email-service/src ./src/email-service/src
COPY src/enclave-builder/src ./src/enclave-builder/src

ENV RUST_BACKTRACE=1
ENV RUSTFLAGS="-C codegen-units=1"
ENV RUSTFLAGS="${RUSTFLAGS} -C target-feature=+crt-static"
ENV RUSTFLAGS="${RUSTFLAGS} -C link-arg=-Wl,--build-id=none"
ENV TARGET_ARCH="x86_64-unknown-linux-musl"

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    find /usr/local/cargo/registry -name '.cargo-ok' -delete 2>/dev/null || true && \
    cargo fetch --locked --target $TARGET_ARCH

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,id=email-target,target=/build/target \
    --network=none \
    cargo build --release --frozen \
      --target ${TARGET_ARCH} \
      -p email-service

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,id=email-target,target=/build/target \
    --network=none \
    cargo build --release --frozen \
      --bin email-service \
      --target ${TARGET_ARCH} \
      && install -D -m 0755 /build/target/${TARGET_ARCH}/release/email-service /usr/local/bin/email-service

FROM user-runtime AS runtime

COPY --from=gcc /usr/lib/libgcc_s.so.1 /usr/lib/
COPY --from=gcc /usr/lib/libstdc++.so.6 /usr/lib/
COPY --from=musl /lib/ld-musl-x86_64.so.1 /lib/
COPY --from=libunwind /lib/libunwind.so.8 /lib/
COPY --from=ca-certificates /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=builder /usr/local/bin/email-service /usr/local/bin/email-service

WORKDIR /app

ENV RUST_LOG=info

EXPOSE 8082

ENTRYPOINT ["email-service"]
